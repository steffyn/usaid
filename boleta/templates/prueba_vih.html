{% extends 'base.html' %}
{% load staticfiles %}
{% load bootstrap %}


{% block contenido %}
<link rel="stylesheet" href="{% static 'plugins/select2/select2.css' %}">
<link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">


<script src="{% static 'js/jquery-2.2.3.min.js' %}"></script>
<script src="{% static 'plugins/input-mask/jquery.inputmask.js' %}"></script>
<script src="{% static 'plugins/input-mask/jquery.inputmask.date.extensions.js' %}"></script>
<script src="{% static 'plugins/input-mask/jquery.inputmask.extensions.js' %}"></script>
<script src="{% static 'plugins/select2/select2.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/moment.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>

<div class="box box-primary">
  <div class="box-header with-border">
    <h3 class="box-title">Prueba de VIH</h3>
  </div>
  <form  class="form-horizontal" role="form"  method="POST">
    {% csrf_token %}
    <div class="box-body">
        {% if exito %}
          <div class="alert alert-success" role="alert"> 
            Se guardaron los datos correctamente 
          </div>
        {% endif %}
        <div class="row">
          <div class="col-sm-8">
            <div class="form-group">
              <label for="inputEmail3" class="col-sm-4 control-label">Identidad</label>
              <div class="col-sm-8 form-inline">
                <input type="text" class="form-control" id='identidad' name="identidad" data-inputmask='"mask": "9999-9999-99999"' data-mask>
                <span class="label label-danger "  id='error_identidad' style="display:none">No se encontraron registros con la identidad ingresadda</span>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-8">
            <div class="form-group">
              <label for="inputEmail3" class="col-sm-4 control-label">Número de Expediente Clínico</label>
              <div class="col-sm-8">
                <input type="text" class="form-control" id="expediente" name='expediente' readonly >
                <input type="hidden" class="form-control" id="boleta" name='boleta' readonly >
              </div>
            </div>
          </div>
        </div>

        <div class="row">

          <div class="col-sm-8">
            {{formulario.fecha_solicitud|bootstrap_horizontal:'col-md-4'}}
            {{formulario.numero_prueba|bootstrap_horizontal:'col-md-4'}}
            {{formulario.fecha_extraccion|bootstrap_horizontal:'col-md-4'}}
            {{formulario.fecha_muestra|bootstrap_horizontal:'col-md-4'}}
            {{formulario.fecha_prueba|bootstrap_horizontal:'col-md-4'}}
            {{formulario.nombre_persona_prueba|bootstrap_horizontal:'col-md-4'}}
            {{formulario.kit_prueba_tamizaje|bootstrap_horizontal:'col-md-4'}}
            {{formulario.resultado_prueba_tamizaje|bootstrap_horizontal:'col-md-4'}}
            <div id='prueba_positiva' style="display:none">
              {{formulario.kit_prueba_confirmatoria|bootstrap_horizontal:'col-md-4'}}
              {{formulario.fecha_prueba_confirmatoria|bootstrap_horizontal:'col-md-4'}}
              {{formulario.resultado_prueba_confirmatoria|bootstrap_horizontal:'col-md-4'}}
              {{formulario.nombre_laboratorio|bootstrap_horizontal:'col-md-4'}}
              {{formulario.fecha_refirio_prueba_confirmatoria|bootstrap_horizontal:'col-md-4'}}
            </div>
          </div>
        </div>
        
    </div>
    <div class="box-footer">
      <div class="row">
        <div class="col-xs-12 no-print">
          <button type="submit" class="btn btn-primary">Guardar Registro</button>
          <button type="button" class="btn btn-success"><i class="fa fa-print"></i>Imprimir Boleta
          </button>
        </div>
      </div>

      
    </div>
  </form>
</div>
<script type="text/javascript">
   $(":input").inputmask();
   $("select").select2();
  $('#id_fecha_solicitud, #id_fecha_extraccion, #id_fecha_muestra, #id_fecha_prueba, #id_fecha_prueba_confirmatoria, #id_fecha_refirio_prueba_confirmatoria').daterangepicker({
        singleDatePicker: true,
        maxDate: moment(),
        showDropdowns: true,
        locale: {
          format: 'YYYY-MM-DD',
          daysOfWeek: [
            "Do",
            "Lu",
            "Ma",
            "Mi",
            "Ju",
            "Vi",
            "Sa"
        ],
        monthNames: [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre"
        ],
        },
    },
    function(start, end, label) {
        var years = moment().diff(start, 'years');
        //alert("You are " + years + " years old.");
    }).val('');




  //BUSQUEDA DE IDENTIDAD
  $('#identidad').keypress(function (e) {
      event.preventDefault();
      identidad = $(this).val().replace('-', '');
      identidad = identidad.replace('-', '')
      var key = e.which;
      if(key == 13){
        $.ajax({
          url: "{% url 'prueba_vih' %}",
          data: { 
                  identidad: identidad
                }
        })
          .done(function( data ) {
            console.log(data)
            if (data.persona==false){
              $('#error_identidad').show()
              $('#expediente,#id_fecha_solicitud, #id_numero_prueba, #id_fecha_extraccion, #id_fecha_muestra, #id_fecha_prueba, #id_kit_prueba_tamizaje, #id_resultado_prueba_tamizaje, #id_nombre_persona_prueba, #id_fecha_prueba_confirmatoria, #id_related_name, #id_institucion_prueba_confirmatoria, #id_resultado_prueba_confirmatoria, #id_nombre_laboratorio, #id_fecha_refirio_prueba_confirmatoria').val('')
            }else{
              console.log(data)
              $('#error_identidad').hide()
              $('#id_numero_prueba').val(data.numero_prueba)
              $('#expediente').val(data.expediente)
              $('#boleta').val(data.boleta.pk)
              $('#id_nombre_persona_prueba').val(data.boleta.primer_nombre + ' ' + data.boleta.segundo_nombre + ' ' + data.boleta.primer_apellido + ' ' + data.boleta.segundo_apellido)
            }
          });
      }
  });

  $('input[name=resultado_prueba_tamizaje]').change(function(){
    if ($(this).val() == 1){
      $('#prueba_positiva').show()
    }else{
      $('#prueba_positiva').hide()
    }
  })
</script>
{% endblock %}

